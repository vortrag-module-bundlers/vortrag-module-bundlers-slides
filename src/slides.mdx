import { Image, FlexBox, Quote } from "spectacle";
import Test from "./test-component";
export const testProp = 50;

# Module Bundler im Frontend - das Warum und Wie

---

## Wof√ºr ein Module Bundler?

Ein Module Bundler wird in der Entwicklung einer Webanwendung ben√∂tigt, da Browser traditionell kein Modulsystem unterst√ºtzen
(heute nicht mehr korrekt - sp√§ter). 

Das bedeutet, ein Entwickler m√ºsste sich selbst von Hand darum k√ºmmern, alle ben√∂tigten Codedateien zu laden. 

---

## Wie laden Webbrowser traditionell JavaScript Dateien?

Der normale Weg, eine JavaScript Datei zu laden, ist durch den ```<script>``` Tag. 

```html
<body>
  <div>The normal content</div>

  <!--
    Dabei werden die Tags in der Reihenfolge verarbeitet, in der sie im Dokument stehen. 
    Eine M√∂glichkeit, Abh√§ngigkeiten in den JavaScript Dateien auszuwerten, existiert auf dieser Ebene nicht. 
  -->
  <script src="script1.js"></script>
  <script src="script2.js"></script>
</body>
```

---

# Wie kann ein Entwickler Abh√§ngigkeiten in einem Projekt verwalten?

---

## Manuell

```html
<body>
  <div>The normal content</div>

  <script src="lib1.js"></script>
  <script src="lib2.js"></script>
  <script src="dependency-of-lib3.js"></script>
  <script src="lib3.js"></script>
  <script src="script1.js"></script>
  <script src="script2.js"></script>
  <script src="script3.js"></script>
  <script src="script4.js"></script>
  <script src="script5.js"></script>
</body>
```

Disclaimer: So habe ich tats√§chlich damals angefangen, Webanwendungen zu schreiben.

---

<FlexBox alignContent="center" justifyContent="center">
  <Image
    src="https://pbs.twimg.com/media/DB6QcoNVYAA-w6N:small?format=jpg"
    alt="Mozilla dependency graph"
    width="680px"
    height="530px"
  />
</FlexBox>

Das Problem ist, manuell Abh√§ngigkeiten pflegen ger√§t sehr schnell au√üer
Kontrolle ...

---

<FlexBox alignContent="center" justifyContent="center" height="100%">
  <Image
    src="https://media.giphy.com/media/QvMlVkJ3XSSj9cOxDM/source.gif"
    alt="Hell"
  />
</FlexBox>

---

### Globaler Namespace

Eine weitere Herausforderung von Importen via Script-Tags ist, standardm√§√üig wird der Inhalt der geladenen Datei dem globalen Namespace hinzugef√ºgt. 
Skripte k√∂nnen sich also gegenseitig Dinge "zerst√∂ren", das zuletzt geladene Skript "gewinnt".

Das Problem kann √ºber sogenannte [IIFE](https://developer.mozilla.org/de/docs/Glossary/IIFE) teilweise gel√∂st werden.

---

## Module Bundler

Um die Schwierigkeiten mit manuellen Importen immer komplexer werdenden Anwendungen zu beheben, wurden ca. ab 2011 sogenannte Module Bundler 
wie [browserify](http://browserify.org/) oder [webpack](https://webpack.js.org/) entwickelt.

Diese Tools erm√∂glichen den Entwicklern, Code modular zu schreiben.
Das Aufl√∂sen von Abh√§ngigkeiten und die Konvertierung von Quelldateien in ein f√ºr Browser verst√§ndliches Format wird von diesen Tools √ºbernommen.

---

## ECMAScript Module

[Moderne Browser](https://caniuse.com/es6-module) implementieren ein eigenes Modulsystem, genannt [ES Module](https://developer.mozilla.org/de/docs/Web/JavaScript/Guide/Modules).
Dieses erm√∂glich es Entwicklern, modularen Code zu schreiben und diesen unver√§ndert in Browsern auszuf√ºhren.
Dieser k√ºmmert sich selbst darum, alle Anh√§ngigkeiten korrekt zu laden.

Damit entf√§llt - _theoretisch_ - die Notwendigkeit einen Bundler einzusetzen.

---

### Buildless

Tats√§chlich kann man heutzutage kleinere Projekte, die auschlie√ülich auf moderne Browser abzielen, ohne eigenen Buildprozess entwickeln.

Diese Art der Webentwicklung wird unter dem Begriff [buildless](https://buildless.site/) zusammengefasst.

---

# Aufgaben eines Module Bundlers heute

In der Praxis st√∂√üt man bei gr√∂√üeren Projekten (read: alles was wir so machen) relativ schnell an technische Grenzen, wenn man komplett auf einen Buildprozess verzichtet.

Daher ist auch heutzutage der Einsatz eines Module Bundlers und einer Build-Pipeline meistens sinnvoll.

---

## Module Resolution

Unter module resolution versteht man das Aufl√∂sen der Abh√§ngigkeiten aller Codedateien untereinander.
Dabei wird ein sog. Abh√§ngigkeitsbaum aufgebaut und damit die korrekte Ladereihenfolge aller Dateien sichergestellt.

So ist jede abh√§ngige Datei bereits geladen, sobald sie ben√∂tigt wird und ein Entwickler verwaltet das nicht mehr manuell (dependency hell).

---

## Transpile

Unter den Begriff Tanspilierung versteht man allgemein das √úbersetzen einer Quelldatei von einer Hochsprache in eine andere Hochsprache.

Der Unterschied zu Kompilierung ist, dort wird eine Hochsprache (z.B. C++, Java) in Maschinen- oder Bytecode √ºbersetzt.

---

## Transpile

Heutzutage gibt es viele Programmiersprachen, die auf Web-Basistechnologien (HTML, CSS, JavaScript) aufsetzten und diese um neue M√∂glichkeiten erweitern.
Beliebte Beispiele hierf√ºr sind z.B. TypeScript (JavaScript), SASS und PostCSS (CSS) oder Pug (HTML).

Viele Module Bundler bieten Unterst√ºtzung f√ºr diese Sprachen und √ºbernehmen die √úbersetzung in die entsprechenden _Web-Sprachen_ automatisch.

---

## Bundle

Der Bundle Schritt, der diesen Tools ihren Namen gibt, ist das B√ºndeln der einzelnen Quelldateien in ein oder wenige Code-Pakete.

Um Browser und Netzwerk nicht mit dem Herunterladen hunderter oder tausender einzelner Dateien zu belasten, werden diese zu wenigen gro√üen Dateien zusammengef√ºgt.

---

## Statische Assets

Statische Assets wie Bilder, JSON, Manifeste oder √§hnliche Dateien, die nicht direkt weiterverarbeitet werden, sind ebenfalls Teil des Build-Prozesses.

Ein Module Bundler ist daf√ºr verantwortlich, diese in den endg√ºltigen Build abzulegen und auszuliefern.

---

## Development Tooling

Um Entwicklern die t√§gliche Arbeit zu erleichtern, bieten Bundler hierf√ºr oft spezielles Tooling:

- Dev server
- Source maps
- Statische Codeanalyse (Linter, Compiler)

---

## Production Build Optimierungen

W√§hrend der Development Build sich vor allem darauf konzentriert, Entwicklern die Arbeit zu erleichtern,
ist die Aufgabe des Production Builds, Anwendungen f√ºr den Betrieb auf den Zielplattformen, also unterst√ºtzten Browsern zu optimieren.

Hierf√ºr werden mehrere Schritte im Build durchlaufen, die w√§hrend der Entwicklung √ºblicherweise weggelassen werden.

---

### Minification

Der gebaute Quellcode wird in diesem Schritt durch ein Programm geschickt, das die Codemenge m√∂glichst reduzieren soll.
Zu diesem Zweck wird aller unnn√∂tiger Whitespace entfernt, Variablennamen gek√ºrzt oder Kommentare entfernt.

Ziel ist, die √ºber das Netzwerk zu √ºbertragende Menge an Bytes so klein wie m√∂glich zu halten.

---

### Minification

Ein angenehmer Nebeneffekt ist - der Ergebniscode ist schlechter lesbar, kann also viel schwerer von Konkurrenten "ausgeliehen" werden.

```javascript
// vorher
const hello = (firstName, lastName) => {
  return `Hello ${firstName} ${lastName}`;
};

const helloWorld = (firstName, lastName) => {
  return `Hello world ${firstName} ${lastName}`;
};

// nachher - von https://terser.org/ geparst
const hello=(l,o)=>`Hello ${l} ${o}`,helloWorld=(l,o)=>`Hello world ${l} ${o}`;
```

---

### Tree shaking

Unter tree shaking versteht man das gezielte Entfernen nicht genutzen Codes aus einzelnen Dateien. 

Beispiel:
In einer Codedatei sind drei Funktionen f1, f2 und f3 definiert. 
In der eigentlichen Anwendung wird aus dieser Datei jedoch nur die Funktion f2 importiert und verwendet. 

Der Production Build wird die Funktionen f1 und f3 entfernen und nicht mit ausliefern. 


---

### Code splitting

Code splitting stellt das Gegenteil zum Bundle Schritt dar. Viele einzelne Dateien auszuliefern ist nicht effizient, 
den gesamten Code in eine einzige Datei "zu packen" jedoch auch nicht. 

So werden manche Teile der Codebasis nur an wenigen Stellen einer Anwendung ben√∂tigt. Diese immer zu laden, obwohl ein Kunde 
diese Teile der Anwendung gar nicht nutzt, verlangsamt die Anwendung und verursacht unn√∂tigen Netzwerkverkehr. 

---

### Code splitting

Also stellen Bundler M√∂glichkeiten zur Verf√ºgung, bestimmte Teile des Codes in eigene Teilpakete auszulagern und diese nur 
bei Bedarf zu laden. 

---

### Dynamische Importe

Eine beleibte Methode stellen die sog. dynamischen Importe mit Hilfe der `import` Funktion dar, siehe z.B. [hier](https://2ality.com/2017/01/import-operator.html).

Inzwischen ist auch die [native Unterst√ºtzung](https://caniuse.com/es6-module-dynamic-import) von dynamischen Importen in den meisten Browsern angekommen, 
die so nicht mehr auf Bundler angewiesen sind. 

---

### Optimierte Builds f√ºr moderne und legacy Browser

Sollte das Projekt noch legacy Browser (IE) unterst√ºtzen m√ºssen, gibt es zwei Strategien:

- Der Prod Build generiert ein Ergebnis, das von allen Browsern verstanden wird.
- Es werden zwei Varianten der Anwendung gebaut, eine f√ºr moderne Plattformen, eine f√ºr ... den IE.

---

### Optimierte Builds f√ºr moderne und legacy Browser

Die zweite Variante hat Vorteile: F√ºr moderne Browser optimierter Code ist meistens kleiner (minify) und wird von den JavaScript 
Engines oft performanter ausgef√ºhrt. 

So werden also nicht alle Kunden "bestraft", sondern nur die wenigen mit alten Browsern. 

---

### Beispiel

Folgender Code ...

```javascript
class Person {

  firstName = 'Arthur';
  lastName = 'Dent';

  sayName() {
    return `${this.firstName} ${this.lastName}!`
  }
}
```

---

... wird z.B. vom Babel Transpiler in diesen Code umgewandelt

```javascript
'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { 
  var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; 
  if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } 
  return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); 
  if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Person = function () {
  function Person() {
    _classCallCheck(this, Person);

    this.firstName = 'Arthur';
    this.lastName = 'Dent';
  }

  _createClass(Person, [{
    key: 'sayName',
    value: function sayName() {
      return this.firstName + ' ' + this.lastName + '!';
    }
  }]);

  return Person;
}();
```

den auch ein IE versteht!

---

### Sicherheit und Build-Integrit√§t

Auch das Thema Sicherheit ist beim Ausliefern von Webanwendungen ein wichtiger Punkt. 
Ein beliebter Angriffspunkt ist z.B. die Manipulation des ausgelieferten JavaScripts auf einem CDN. 

Es ist schwer, in einem transpilieren und komprimierten Paket etwaige Manipulationen zu erkennen. 

---

### Sicherheit und Build-Integrit√§t

Moderne Browser bieten gegen diesen Angriff einen Schutz durch die sog. 
[Subresource Integrity](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity). 

Direkt in der Webseite, welche JavaScript Dateien l√§dt, wird eine Checksumme f√ºr jede Datei hinterlegt. 
Passt diese nicht zur geladene Datei, wird sie sofort verworfen und nicht ausgef√ºhrt. 
Webpack beispielsweise kann diese Checksummen automatisiert w√§hrend des Builds generieren. 

---

### Bau einer PWA

Auch der Bau einer PWA (Progressive Web App), kann durch ein Buildtool sehr erleichter werden. 

Sowohl das aufwendige Generieren eines [Service Workers](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers)
als auch der ben√∂tigten Manifest Datei kann automatisiert werden.

---

# Webpack

Webpack ist der aktuell verbreitetste JavaScript Bundler. Mit aktuell ca. 16 Millionen Downloads pro Woche wird er von der Mehrzahl 
aller Webprojekte eingesetzt. 

Die besondere St√§rke von webpack liegt in der extremen Konfigurierbarkeit und Erweiterbarkeit durch Plugins. 

---

# Webpack

<Quote>You can configure that in ...</Quote>
<Quote>We have a plugin for that!</Quote>

Default answers for webpack questions on Stackoverflow üòâ. 

---

## St√§rken von webpack

Webpack bietet Unterst√ºtzung f√ºr praktisch jeden Browser (bis hinunter zum IE8) und jede noch so exotische Technologie. 

Als Beispiel, diese Folien wurden in Markdown geschrieben und von einem Webpack Loader in das HTML umgewandelt, das hier zu sehen ist. 

---

## Webpack Konzepte

Webpack liegen einige grundlegende Konzepte zugrunde, auf die ich kurz eingehen m√∂chte.

---

### Entry

Ein Entry (Einstiegspunkt) bezeichnet in webpack den Beginn eines Abh√§ngigkeitsbaumes. 
Alles was diese Datei importiert, wird rekursiv aufgel√∂st und von Webpack in ein Paket geschn√ºrt. 

Man kann einen oder auch mehrere Einstiegspunkte definieren, aus denen webpack dann jeweils einen einen Baum errechnet. 

---

### Output

In Output wird konfiguriert wo und in welcher Form die geschn√ºrten Pakete abgelegt werden. 

Hier wird beispielsweise das Ausgabeverzeichnis oder die generierten Dateinamen (optional mit Content-Hashes) festgelegt.

---

### Mode

Der Mode, entweder _development_ oder _production_, legt das grunds√§tzliche Verhalten des Buildvorgangs fest. 

So wird in _production_ zum Beispiel auf den Code Operationen wie tree shaking, minification etc. angewendet. 
Diese m√ºssen nicht einzeln konfiguriert werden (k√∂nnen aber), sondern werden √ºber diesen zentralen Schalter gesteuert. 

---

### Loader

Standardm√§√üig kann webpack ausschlie√ülich JavaScript Dateien und seit Version 5 statische Assets verarbeiten. Die Unterst√ºtzung aller weiteren Dateitypen muss √ºber sogenannte Loader
nachger√ºstet werden. 

---

### Loader

So besteht eine Loader Konfiguration immer aus einem regul√§ren Ausdruck, der eine oder mehrere Dateiendungen beschreibt 

(z.B. ```/\.tsx?$/``` f√ºr .ts und .tsx Dateien) 

und dem Namen eines Loaders, f√ºr .tsx Dateien zum Beispiel ```ts-loader```, der TypeScript Dateien verarbeiten kann. 

---

### Loader

Es ist ebenfalls m√∂glich, Loader hintereinander zu schalten und jeden einzeln zu konfigurieren. 

Eine √ºbliche Kombination ist z.B. SASS Dateien erst durch den sass-loader in CSS umzuwandeln 
und dieses Zwischenergebnis danach durch den postcss-loader weiter zu verarbeiten. 

---

### Plugin

W√§hrend ein Loader immer auf bestimmen Dateitypen arbeitet, ist ein Plungin breiter angeelgt und kann an beliebigen Stellen im Build Prouzess eingreifen. 

Plugins sind in webpack das m√§chtigste Werkzeug und stellen vom Definieren von Umgebungsvariablen oder Nachrichten bei Build Fehlern √ºber die 
Minifizierung bis zur Analyse des Buildergebnisses alle erweiterten Funktionen bereit. 

---

### Plugin

Schon die [offizielle Liste](https://webpack.js.org/plugins/) der von webpack selbst verwalteten Plugins ist lang, die von der Community gepflegten ist noch wesentlich umfangreicher. 

Eine Suche nach _webpack-plugin_ in der NPM Registry liefert [√ºber 300 Seiten](https://www.npmjs.com/search?q=webpack-plugin) Ergebnisse. 
Mir pers√∂nlich ist bislang kein Use Case untergekommen, f√ºr den es nicht einen webpack Plugin gab. 

---

<FlexBox alignContent="center" justifyContent="center" height="100%">
  <Image
    src="https://media.giphy.com/media/13ZVRnWnmSMaRy/source.gif"
    alt="Showtime"
    height="50%"
  />
</FlexBox>

---

# Snowpack

Snowpack ist ein relativ junges Projekt (Version 1.0 Januar 2020), das im Kern fest auf ES Modulen aufbaut.

Damit √ºberl√§sst Snowpack den (modernen) Browsern selbst die Aufgabe, den Abh√§ngigkeitsbaum aufzubauen und die Ladereihenfolge zu bestimmen und √ºbernimmt "_nur_" Aufgaben wie das Transpilieren von z.B. TypeScript oder das Bereitstellen eines Dev Servers.

---

# Snowpack

Durch den Verzicht auf die Unterst√ºtzung von legacy Browsern (stimmt nur teilweise, dazu sp√§ter mehr), kann Snowpack den Build Schritt komplett √ºberspringen.

Dies bringt besonders w√§hrend der Entwicklungsphase enorme Vorteile.

---

<FlexBox alignContent="center" justifyContent="center" height="100%">
  <Image
    src="https://media.giphy.com/media/LfT85xyPFiGrK/source.gif"
    alt="Fast"
    height="50%"
  />
</FlexBox>

---

## Snowpack in Dev

W√§hrend der Entwicklung kommt es zu praktisch keinen merklichen Buildzeiten, da immer nur die eine eben ge√§nderte Datei neu gebaut und an den Browser gesendet wird. 
Der Rest liegt dort ohnehin bereits im Cache.

Dies gilt auch und besonders f√ºr gr√∂√üere, gewachsene Projekte, indenen Bundler wie webpack mit jeder neu hinzugef√ºgten Datei ein _kleines bisschen_ langsamer werden.

---

<FlexBox alignContent="center" justifyContent="center" height="100%">
  <Image
    src="https://media.giphy.com/media/13ZVRnWnmSMaRy/source.gif"
    alt="Showtime"
    height="50%"
  />
</FlexBox>

---

## Vorteile von Snowpack

- Sehr schneller Dev Build
- Unterst√ºtzung f√ºr alle g√§ngigen Formate (TypeScript, JSX, SASS, CSS Module ...) fest eingebaut.
- Wenig Konfiguration notwendig, viele Konventionen
- Aktives √ñkosystem an Erweiterungen (trotzdem kein Vergleich mit webpack)
- Erweiterungen selbst zu entwickeln ist vergleichsweise einfach

---

## Nachteile von Snowpack

- Keine native Unterst√ºtzung f√ºr legacy Browser (= IE)
- Weniger Einstellm√∂glichkeiten - wenn man sie braucht
- Deutlich kleineres √ñkosystem im Vergleich zu webpack

---

<FlexBox
  alignContent="center"
  justifyContent="space-around"
  height="90%"
  flexDirection="column"
>
  <Image
    src="/src/assets/snowpack-webpack.png"
    alt="Snowpack vs webpack in downloads"
    height="100%"
  />
  <p>
    <a href="https://www.npmtrends.com/snowpack-vs-webpack" target="_blank">
      Snowpack vs webpack
    </a>
  </p>
</FlexBox>

---

## Snowpack in Produktion

F√ºr den Production Build erm√∂glicht Snowpack, an das Ende des Buildprozesses noch einen klassischen Bundler einzuh√§ngen.
Dieser √ºbernimmt dann Aufgaben wie minification, tree shaking oder Builds f√ºr legacy Browser.

Aktuell werden die Bundler esbuild (modern, extrem schnell aber junges Projekt), webpack (inklusive Plugins) und rollup unterst√ºtzt.

---

## Snowpack + webpack

Durch die Kombination aus einem sehr schlanken und schnellen Entwicklungsprozess und der M√§chtigkeit und Flexibilit√§t von Webpack in Produktion,
hat er gemeinsame Einsatz von Snowpack und webpack das Potential, auch in gro√üen und komplexen Projekten erfolgreich zu sein.

F√ºr neu startende Projekte w√ºrde ich inzwischen ernsthaft den Einsatz von Snowpack evaluieren und bei Bedarf webpack f√ºr die Produktion erg√§nzen.

---

# Folien und Quellcode

Die Anwendung zur Darstellung der Folien und die zwei Beispielanwendungen zum Ausprobieren findet ihr unter 

[https://github.com/vortrag-module-bundlers](https://github.com/vortrag-module-bundlers)

---

<FlexBox
  alignContent="center"
  justifyContent="center"
  height="100%"
>
  <h1>Fragen?</h1>
</FlexBox>


